name: PixelOS Mondrian Android 16 - Crave Build

on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'Clean build? (true/false)'
        required: false
        default: 'true'
      lunch_target:
        description: 'Lunch target'
        required: true
        default: 'pixelos_mondrian-userdebug'
      make_command:
        description: 'Make command'
        required: false
        default: 'mka bacon -j$(nproc --all)'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Crave
        run: |
          curl -sL https://raw.githubusercontent.com/accupara/crave/master/get_crave.sh | bash -s -- -s || true
          # Фикс PATH — Crave обычно в /usr/local/bin
          echo "/usr/local/bin" >> $GITHUB_PATH
          # Проверка
          which crave || echo "crave not found in PATH"
          crave --version || echo "crave version check failed"

      - name: Configure Crave
        env:
          CRAVE_CONF: ${{ secrets.CRAVE_CONF }}
        run: |
          mkdir -p ${HOME}/.config/crave
          echo "$CRAVE_CONF" > ${HOME}/.config/crave/crave.conf
          crave whoami

      - name: Run Build on Crave
        run: |
          crave -k -c ${HOME}/.config/crave/crave.conf -v run \
            ${{ github.event.inputs.clean_build == 'true' && '--clean' || '' }} \
            --no-patch -- \
            "mkdir -p pixel && cd pixel && \
            repo init -u https://github.com/PixelOS-AOSP/android_manifest.git -b sixteen-qpr2 --git-lfs && \
            rm -rf .repo/local_manifests && \
            mkdir -p .repo/local_manifests && \
            curl -sL https://raw.githubusercontent.com/${{ github.repository }}/main/mondrian.xml -o .repo/local_manifests/mondrian.xml && \
            repo sync -c -j\$(nproc --all) --force-sync --no-tags --no-clone-bundle || repo sync -c -j1 --force-sync --no-tags --no-clone-bundle --fail-fast && \
            source build/envsetup.sh && \
            (breakfast mondrian || true) && \
            (cp -f device/xiaomi/mondrian/lineage_mondrian.mk device/xiaomi/mondrian/pixelos_mondrian.mk || true) && \
            lunch ${{ github.event.inputs.lunch_target }} && \
            ${{ github.event.inputs.make_command }}"

      - name: Pull Artifact (zip)
        if: always()
        run: |
          crave -k -c ${HOME}/.config/crave/crave.conf pull pixel/out/target/product/mondrian/*.zip || echo "No zip found, check build logs"

      - name: Upload Artifact to GitHub
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pixelos-mondrian-build
          path: pixel/out/target/product/mondrian/*.zip
          if-no-files-found: warn
          retention-days: 7
