name: PixelOS Mondrian Android 16 - Crave Build

on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'Clean build? (true/false)'
        required: false
        default: 'true'
      lunch_target:
        description: 'Lunch target'
        required: true
        default: 'pixelos_mondrian-userdebug'  # Если не найдёт — смени на aosp_mondrian-userdebug
      make_command:
        description: 'Make command'
        required: false
        default: 'mka bacon -j$(nproc --all)'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Crave CLI
        run: |
          curl -L -o crave https://github.com/accupara/crave/releases/download/0.2-7193/crave-0.2-7193-linux-amd64.bin
          chmod +x crave
          sudo mv crave /usr/local/bin/crave
          echo "/usr/local/bin" >> $GITHUB_PATH
          crave --version

      - name: Configure Crave
        env:
          CRAVE_TOKEN: ${{ secrets.CRAVE_TOKEN }}
        run: |
          mkdir -p \~/.crave/config
          echo "$CRAVE_TOKEN" > \~/.crave/config/crave.conf
          crave whoami

      - name: Run Build on Crave
        env:
          LUNCH: ${{ github.event.inputs.lunch_target }}
          MAKE: ${{ github.event.inputs.make_command }}
        run: |
          crave run \
            ${{ github.event.inputs.clean_build == 'true' && '--clean' || '' }} \
            --no-patch --verbose \
            -- bash -c '
              set -e
              mkdir -p rom && cd rom
              repo init -u https://github.com/PixelOS-AOSP/android_manifest.git -b sixteen-qpr2 --git-lfs
              mkdir -p .repo/local_manifests
              curl -sL https://raw.githubusercontent.com/${{ github.repository }}/main/mondrian.xml -o .repo/local_manifests/mondrian.xml
              repo sync -c -j$(nproc --all) --force-sync --no-tags --no-clone-bundle
              source build/envsetup.sh
              lunch $LUNCH || { echo "Lunch error: проверь mk-файлы в device/xiaomi/mondrian (должен быть pixelos_$DEVICE.mk)"; exit 1; }
              export ALLOW_MISSING_DEPENDENCIES=true
              $MAKE
            '

      - name: Pull Artifact
        if: always()
        run: |
          crave pull rom/out/target/product/mondrian/pixelos_mondrian-*.zip || \
          crave pull rom/out/target/product/mondrian/*mondrian*.zip || echo "No ZIP, build failed earlier"

      - name: Upload Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pixelos-android16-mondrian
          path: rom/out/target/product/mondrian/*.zip
          if-no-files-found: warn
          retention-days: 7
