name: PixelOS Mondrian - Crave Build

on:
  workflow_dispatch:   # Запуск вручную (самый удобный для тестов)
    inputs:
      clean:
        description: 'Clean build? (true/false)'
        required: false
        default: 'true'
      lunch_target:
        description: 'Lunch target'
        required: true
        default: 'pixelos_mondrian-userdebug'
      make_cmd:
        description: 'Make command'
        required: false
        default: 'mka bacon -j$(nproc --all)'

jobs:
  build-on-crave:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Crave CLI (manual stable method)
        run: |
          # Установка вручную — избегаем проблем с get_crave.sh и PATH
          CRAVE_VERSION="0.2-7193"  # Актуальная на февраль 2026 — проверь на https://github.com/accupara/crave/releases/latest если нужно обновить
          curl -L -o crave https://github.com/accupara/crave/releases/download/\( {CRAVE_VERSION}/crave- \){CRAVE_VERSION}-linux-amd64.bin
          chmod +x crave
          sudo mv crave /usr/local/bin/crave
          # Добавляем путь в GITHUB_PATH — чтобы crave был виден во всех шагах
          echo "/usr/local/bin" >> $GITHUB_PATH
          crave --version   # Должно вывести версию — проверка

      - name: Crave Login with Token
        env:
          CRAVE_TOKEN: ${{ secrets.CRAVE_TOKEN }}
        run: |
          mkdir -p \~/.crave/config
          echo "$CRAVE_TOKEN" > \~/.crave/config/crave.conf
          crave whoami   # Проверка — должно показать твой username

      - name: Setup Crave (project/remote)
        run: |
          crave remote --setup || true   # Если уже настроено — не ошибка

      - name: Run Build on Crave Servers
        env:
          CLEAN_BUILD: ${{ github.event.inputs.clean }}
          LUNCH: ${{ github.event.inputs.lunch_target }}
          MAKE: ${{ github.event.inputs.make_cmd }}
        run: |
          crave run \
            ${{ inputs.clean == 'true' && '--clean' || '' }} \
            --no-patch \
            -- bash -c '
              set -e
              echo "Starting build environment..."
              source build/envsetup.sh || { echo "envsetup failed"; exit 1; }
              repo sync -c -j$(nproc --all) --force-sync --no-tags || echo "Repo sync skipped/partial"
              lunch $LUNCH || { echo "Lunch failed — check device mk files"; exit 1; }
              export ALLOW_MISSING_DEPENDENCIES=true
              echo "Starting compilation..."
              $MAKE
            '

      - name: Pull the Built ZIP (if success)
        if: success()
        run: |
          crave pull out/target/product/mondrian/pixelos_mondrian-*.zip || echo "ZIP pull failed — check build logs"
          ls -la out/target/product/mondrian/ || true

      - name: Upload Artifact (ZIP file)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pixelos-mondrian-rom
          path: out/target/product/mondrian/*.zip
          if-no-files-found: warn
          retention-days: 5

      - name: Show Build Logs (last lines if failed)
        if: failure()
        run: |
          crave logs last || echo "No logs available"
